name: ci

on: [push, pull_request]

jobs:
  build-bin:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build-and-export.outputs.digest }}
    steps:
      - name: Clone repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Build and export
        id: build-and-export
        uses: docker/build-push-action@v2
        with:
          file: bin.dockerfile
          context: .
          outputs: type=docker,dest=/tmp/bin-image.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: bin-image
          path: /tmp/bin-image.tar

  build:
    needs: build-bin
    name: ${{ matrix.kind }}
    runs-on: ubuntu-latest-xl
    strategy:
      matrix:
        kind: ["alpine", "centos", "debian", "distroless", "ubuntu"]
    steps:
      - name: Clone repository
        uses: actions/checkout@v2

      - name: Download bin image artifact
        uses: actions/download-artifact@v2
        with:
          name: bin-image
          path: /tmp

      - name: Load bin image
        run: |
          docker load --input /tmp/bin-image.tar

      - name: Build image
        run: |
          docker build -f ${{ matrix.kind }}.dockerfile -t ${{ matrix.kind }} \
            --build-arg BIN_IMAGE=${{ needs.build-bin.outputs.image-digest }} .
          docker run -t ${{ matrix.kind }}

      - name: Test basic run
        run: |
          docker run -t ${{ matrix.kind }} run https://deno.land/std/examples/welcome.ts

      - name: Test entry script
        if: ${{ matrix.kind != 'distroless' }}
        run: |
          docker run -t ${{ matrix.kind }} deno run https://deno.land/std/examples/welcome.ts
          docker run -t ${{ matrix.kind }} echo 'test entry script'

      - name: Login to Docker Hub
        if: github.repository == 'denoland/deno_docker' && startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Push named images
        if: github.repository == 'denoland/deno_docker' && startsWith(github.ref, 'refs/tags/')
        run: |
          docker tag ${{ matrix.kind }} denoland/deno:${{ matrix.kind }}-${GITHUB_REF#refs/*/}
          docker tag ${{ matrix.kind }} denoland/deno:${{ matrix.kind }}
          docker push denoland/deno:${{ matrix.kind }}-${GITHUB_REF#refs/*/}
          docker push denoland/deno:${{ matrix.kind }}

      - name: Push bin image
        if: github.repository == 'denoland/deno_docker' && startsWith(github.ref, 'refs/tags/') && matrix.kind == 'debian'
        run: |
          docker tag ${{ needs.build-bin.outputs.image-digest }} denoland/deno:bin-${GITHUB_REF#refs/*/}
          docker tag ${{ needs.build-bin.outputs.image-digest }} denoland/deno:bin
          docker push denoland/deno:bin-${GITHUB_REF#refs/*/}
          docker push denoland/deno:bin

      - name: Push default image
        if: github.repository == 'denoland/deno_docker' && startsWith(github.ref, 'refs/tags/') && matrix.kind == 'debian'
        run: |
          docker tag ${{ matrix.kind }} denoland/deno:${GITHUB_REF#refs/*/}
          docker tag ${{ matrix.kind }} denoland/deno:latest
          docker push denoland/deno:${GITHUB_REF#refs/*/}
          docker push denoland/deno:latest
